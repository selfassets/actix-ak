# =============================================================================
# GitHub Actions 自动构建和发布工作流
# 功能：构建 Docker 镜像并推送到 GitHub Container Registry
# =============================================================================

name: Build and Release

# 触发条件
on:
  push:
    branches:
      - main      # 推送到 main 分支时触发
      - master    # 推送到 master 分支时触发
  workflow_dispatch:  # 支持手动触发

# 环境变量
env:
  REGISTRY: ghcr.io                       # GitHub Container Registry
  IMAGE_NAME: ${{ github.repository }}    # 镜像名称，使用仓库名

# =============================================================================
# 任务定义
# =============================================================================
jobs:
  # ---------------------------------------------------------------------------
  # 任务 1: 构建并推送 Docker 镜像
  # ---------------------------------------------------------------------------
  build-and-push:
    runs-on: ubuntu-latest
    # 仅当 commit message 包含 "release" 或手动触发时才执行
    if: contains(github.event.head_commit.message, 'release') || github.event_name == 'workflow_dispatch'
    
    # 权限设置
    permissions:
      contents: read      # 读取仓库内容
      packages: write     # 写入容器包

    steps:
      # 步骤 1: 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤 2: 设置 Docker Buildx（支持多平台构建）
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 步骤 3: 登录到容器仓库
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      # 步骤 4: 提取 Docker 元数据（标签、标注）
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}        # 完整版本号，如 v1.2.3
            type=semver,pattern={{major}}.{{minor}} # 主次版本，如 1.2
            type=semver,pattern={{major}}           # 主版本，如 1
            type=raw,value=latest,enable={{is_default_branch}}  # 默认分支标记为 latest
            type=sha,prefix=                        # 使用 commit SHA 作为标签

      # 步骤 5: 构建并推送 Docker 镜像
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .                              # 构建上下文为当前目录
          push: true                              # 推送到仓库
          tags: ${{ steps.meta.outputs.tags }}    # 使用提取的标签
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha                    # 使用 GitHub Actions 缓存加速
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64     # 支持 AMD64 和 ARM64 架构

  # ---------------------------------------------------------------------------
  # 任务 2: 创建 GitHub Release（可选，仅在推送标签时触发）
  # ---------------------------------------------------------------------------
  create-release:
    needs: build-and-push    # 依赖于 build-and-push 任务完成
    runs-on: ubuntu-latest
    
    permissions:
      contents: write        # 需要写权限来创建 Release

    steps:
      # 步骤 1: 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤 2: 创建 GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')  # 仅在推送标签时创建 Release
        with:
          generate_release_notes: true            # 自动生成发布说明
          draft: false                            # 不是草稿
          # 如果标签包含 alpha/beta/rc，标记为预发布版本
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
